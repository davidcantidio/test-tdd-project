name: ğŸ¯ TDD Project Automation
# Automated workflow for TDD project management with Gantt charts and GitHub integration
# Template version - customize for your project

on:
  # Automatic triggers on important changes
  push:
    branches: [ main, develop ]
    paths:
      - 'epics/*.json'          # Epic JSON files
      - 'epic_*.json'           # Legacy epic format
      - 'scripts/analysis/generate_all_diagrams.py'
      - 'tests/scripts/gantt_tracker.py'
      - 'commit_helper.py'
      - '.github/workflows/tdd-automation.yml'
      - 'trigger_workflow.txt'
      - 'trigger_pages_rebuild.md'
  
  # Trigger on Issues related to epics  
  issues:
    types: [opened, closed, labeled, unlabeled, assigned, unassigned]
    
  # Trigger on Milestones
  milestone:
    types: [created, closed, opened, edited, deleted]
  
  # Trigger on Pull Requests for Projects v2 integration
  pull_request:
    types: [opened, closed, synchronize, labeled, unlabeled]
    branches: [ main, develop ]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      github_repo:
        description: 'GitHub Repository (owner/repo)'
        required: false
        default: 'davidcantidio/test-tdd-project'
        type: string
      output_dir:
        description: 'Output directory for .mmd files'
        required: false
        default: 'docs'
        type: string
      force_deploy:
        description: 'Force GitHub Pages deployment even without changes'
        required: false
        default: true
        type: boolean

jobs:
  update-tdd-charts:
    name: ğŸ§  Generate TDD Diagrams
    runs-on: ubuntu-latest
    # environment: 
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      contents: write          # For automatic commit
      issues: read            # For reading Issues
      repository-projects: read # For reading Projects
      # pages: write            # For GitHub Pages deploy (DISABLED - using static.yml)
      # id-token: write         # For GitHub Pages authentication (DISABLED - using static.yml)
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          # Core dependencies for diagram generation
          pip install json5
          echo "âœ… Core dependencies installed"
          
          # Check epic files availability
          echo "ğŸ“‹ Checking epic files availability..."
          ls -la epics/*.json || ls -la epic_*.json || echo "âš ï¸ Epic files not found"
      
      - name: ğŸ” Validate Epic Files
        run: |
          echo "ğŸ“‹ Checking epic files..."
          epic_count=$(find . -name "epic*.json" -type f 2>/dev/null | wc -l)
          if [ $epic_count -eq 0 ]; then
            echo "âŒ No epic files found!"
            exit 1
          fi
          echo "âœ… Found $epic_count epic files"
          
          # Validate JSON syntax
          find . -name "epic*.json" -type f | while read file; do
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "  âœ… $file - valid JSON"
            else
              echo "  âŒ $file - invalid JSON"
              exit 1
            fi
          done
      
      - name: ğŸ¨ Generate TDD Diagrams with GitHub Integration
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          echo "ğŸ§  Starting TDD diagram generation..."
          
          # Use input from workflow dispatch or default
          REPO="${{ github.event.inputs.github_repo || github.repository }}"
          OUTPUT_DIR="${{ github.event.inputs.output_dir || 'docs' }}"
          
          echo "ğŸ”— GitHub Repo: $REPO"
          echo "ğŸ“ Output Dir: $OUTPUT_DIR"
          
          # Execute generator with GitHub integration
          python3 scripts/analysis/generate_all_diagrams.py \
            --github-repo "$REPO" \
            --output-dir "$OUTPUT_DIR"
          
          echo "âœ… Diagrams generated successfully"
      
      - name: ğŸ§ª Analyze TDD Commit Patterns
        run: |
          echo "ğŸ§ª Analyzing TDD commit patterns and epic progress..."
          
          # Check for commits in TDD enhanced pattern
          enhanced_commits=$(git log --oneline --grep="analysis:" --grep="red:" --grep="green:" --grep="refactor:" --since="7 days ago" | wc -l)
          legacy_commits=$(git log --oneline --grep="\\[EPIC-" --since="7 days ago" | wc -l)
          
          echo "ğŸ“Š TDD Commit Analysis (last 7 days):"
          echo "  Enhanced TDD commits: $enhanced_commits"
          echo "  Legacy commits: $legacy_commits"
          
          if [ $enhanced_commits -gt 0 ]; then
            echo "  âœ… Enhanced TDD pattern in use!"
            echo "USING_ENHANCED_TDD=true" >> $GITHUB_ENV
          else
            echo "  â„¹ï¸ Using legacy pattern"
            echo "USING_ENHANCED_TDD=false" >> $GITHUB_ENV
          fi
      
      - name: ğŸ“Š Generate Enhanced Gantt Progress Tracker
        run: |
          echo "ğŸ¯ Generating enhanced Gantt with commit tracking..."
          
          # Install dependencies for the tracker
          pip install plotly pandas
          
          # Generate progress dashboard
          python3 tests/scripts/gantt_tracker.py --output docs/gantt_progress.html --no-open
          
          echo "âœ… Enhanced Gantt progress tracker generated"
      
      - name: ğŸ“Š Generate Diagram Summary
        run: |
          echo "ğŸ“Š Generating summary report..."
          
          cat > docs/gantt-report.md << 'EOF'
          # ğŸ“Š TDD Project - Gantt Chart Report
          
          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **GitHub Repository:** ${{ github.repository }}  
          **Commit:** ${{ github.sha }}  
          **Branch:** ${{ github.ref_name }}
          **TDD Pattern:** ${USING_ENHANCED_TDD:-false}
          
          ## ğŸ¯ Generated Files
          - [ğŸ“‹ Mindmap](./mindmap.mmd) - Hierarchical project structure
          - [ğŸ”„ Flowchart](./flow_dependencies.mmd) - Epic dependencies  
          - [ğŸ“… Gantt Chart](./gantt_schedule.mmd) - Professional timeline with GitHub integration
          - [ğŸ“Š Progress Tracker](./gantt_progress.html) - Interactive TDD progress analytics
          
          ## ğŸ§ª TDD Integration Features
          - âœ… Enhanced commit pattern parsing (analysis/red/green/refactor phases)
          - âœ… Real-time TDD phase tracking per epic
          - âœ… Time accuracy analytics (estimated vs actual)
          - âœ… Completion percentage based on TDD phases
          - âœ… Projects v2 compatible custom fields
          
          ## ğŸ”— GitHub Integration Features  
          - âœ… Interactive links to Issues by Epic
          - âœ… Professional status tags (done, active, crit, milestone)
          - âœ… Milestone connections
          - âœ… Weekend exclusions for realistic timeline
          - âœ… Vertical markers for important dates
          
          ## ğŸŒ Visualization
          Copy any .mmd file content to [Mermaid Live](https://mermaid.live/) for interactive visualization.
          
          ---
          ğŸ¤– Auto-generated by GitHub Actions with enhanced TDD tracking
          EOF
          
          echo "âœ… Summary report created"
      
      - name: ğŸ” Check for Changes
        id: git-check
        run: |
          if git diff --quiet HEAD -- docs/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ”µ No changes detected in diagrams"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ Changes detected in diagrams"
            git diff --stat HEAD -- docs/
          fi
      
      - name: ğŸ’¾ Commit Updated Diagrams
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add generated files
          git add docs/*.mmd docs/gantt-report.md docs/gantt_progress.html
          
          # Detailed commit message
          COMMIT_MSG="ğŸ¯ Auto-update TDD Gantt charts with enhanced progress tracking
          
          - Updated Mindmap, Flowchart, and Professional Gantt
          - Enhanced progress tracker with commit analysis
          - Interactive links to Issues: ${{ github.repository }}
          - Real-time metrics: planned vs actual progress
          - TDD cycle tracking and time accuracy analytics
          - Status tags: done, active, crit, milestone  
          - Weekend exclusions and vertical markers
          
          ğŸ¤– Generated with TDD Project Template
          
          Co-authored-by: GitHub Actions <noreply@github.com>"
          
          git commit -m "$COMMIT_MSG"
          echo "âœ… Changes committed"
      
      - name: ğŸ“¤ Push Changes
        if: steps.git-check.outputs.changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ğŸ—ï¸ Setup Ruby for Jekyll
        if: steps.git-check.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event.inputs.force_deploy == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: ./docs

      - name: ğŸ”§ Build Jekyll Site
        if: steps.git-check.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event.inputs.force_deploy == 'true'
        run: |
          cd docs
          bundle install
          bundle exec jekyll build --destination _site
          echo "âœ… Jekyll site built successfully"
          ls -la _site/

      # GitHub Pages deployment DISABLED - handled by static.yml workflow
      # - name: ğŸ“„ Setup Pages
      #   if: steps.git-check.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event.inputs.force_deploy == 'true'
      #   uses: actions/configure-pages@v4
      #   
      # - name: ğŸ“¦ Upload Pages Artifact
      #   if: steps.git-check.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event.inputs.force_deploy == 'true'
      #   uses: actions/upload-pages-artifact@v3
      #   with:
      #     path: ./docs/_site
      #     
      # - name: ğŸš€ Deploy to GitHub Pages
      #   if: steps.git-check.outputs.changes == 'true' || github.event_name == 'workflow_dispatch' || github.event.inputs.force_deploy == 'true'
      #   id: deployment
      #   uses: actions/deploy-pages@v4
      
      - name: ğŸ’¬ Comment on Related Issues (if triggered by issue)
        if: github.event_name == 'issues' && steps.git-check.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const repo_url = `https://${context.repo.owner}.github.io/${context.repo.repo}/`;
            const comment = `ğŸ¯ **TDD charts updated automatically!**
            
            The project timeline has been refreshed with the latest Epic status.
            
            **View updated dashboards:**
            - ğŸ  [**GitHub Pages Dashboard**](${repo_url}) - Live Gantt + Project Overview
            - ğŸ¯ [**Enhanced Progress Tracker**](${repo_url}gantt_progress.html) - Interactive Analytics
            - ğŸ“‹ [Mindmap](../blob/${{ github.ref_name }}/docs/mindmap.mmd)
            - ğŸ”„ [Dependencies](../blob/${{ github.ref_name }}/docs/flow_dependencies.mmd)  
            
            **Interactive visualization:** Copy diagram content to [mermaid.live](https://mermaid.live/)
            
            ğŸ¤– Auto-generated by TDD Project Template`;
            
            github.rest.issues.createComment({
              issue_number: issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ğŸ“ˆ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tdd-diagrams-${{ github.run_number }}
          path: |
            docs/*.mmd
            docs/gantt-report.md
            docs/gantt_progress.html
          retention-days: 30
      
      - name: ğŸ‰ Success Summary
        if: success()
        run: |
          echo "ğŸ‰ TDD Automation workflow completed successfully!"
          echo ""
          echo "ğŸ“Š Generated Files:"
          find docs -name "*.mmd" -o -name "gantt-report.md" | while read file; do
            echo "  ğŸ“„ $file ($(wc -l < "$file") lines)"
          done
          echo ""
          echo "ğŸŒ View diagrams at: https://mermaid.live/"
          echo "ğŸ“± Repository: https://github.com/${{ github.repository }}"